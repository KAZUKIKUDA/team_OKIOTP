<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>é«˜é€Ÿãƒ¬ãƒ“ãƒ¥ãƒ¼</title>
    <!-- ãƒ¢ãƒã‚¤ãƒ«è¡¨ç¤ºã«æœ€é©åŒ– -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100..900&display=swap" rel="stylesheet">
    <!-- CSSèª­ã¿è¾¼ã¿ -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v=11">
    
    <style>
        /* swipe.html å°‚ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        body {
            overflow: hidden; /* ã‚¹ãƒ¯ã‚¤ãƒ—ä¸­ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢ */
            background-color: #f8fafc;
        }

        .swipe-mode-container {
            max-width: 500px;
            margin: 20px auto;
            text-align: center;
            padding: 0 20px;
            display: flex;
            flex-direction: column;
            height: 90vh;
        }

        .swipe-card-container {
            position: relative;
            width: 100%;
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }

        .swipe-card {
            position: absolute;
            width: 100%;
            height: 100%;
            max-height: 450px;
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 30px;
            box-sizing: border-box;
            user-select: none;
            touch-action: none;
            transition: transform 0.1s linear; /* ã‚¹ãƒ¯ã‚¤ãƒ—ä¸­ã®è¿½å¾“ */
            cursor: grab;
        }
        
        .swipe-card:active {
            cursor: grabbing;
        }

        .card-course-name {
            font-size: 1.6em;
            font-weight: 800;
            color: var(--primary-color);
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .card-teacher {
            font-size: 1.1em;
            color: var(--text-sub);
            font-weight: 600;
            margin-bottom: 20px;
        }

        .card-tags {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .tag {
            background: #f1f5f9;
            color: #64748b;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 600;
        }

        /* ã‚¹ãƒ¯ã‚¤ãƒ—æ™‚ã®ãƒãƒƒã‚¸ï¼ˆLIKE / NOPEï¼‰ */
        .badge-overlay {
            position: absolute;
            top: 40px;
            padding: 5px 10px;
            border: 4px solid;
            border-radius: 8px;
            font-size: 2em;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 2px;
            opacity: 0;
            transform: rotate(-15deg);
            z-index: 10;
            pointer-events: none;
        }
        .badge-like {
            left: 40px;
            color: var(--success-color);
            border-color: var(--success-color);
            transform: rotate(-15deg);
        }
        .badge-nope {
            right: 40px;
            color: var(--text-sub);
            border-color: var(--text-sub);
            transform: rotate(15deg);
        }

        /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ */
        .action-area {
            display: flex;
            gap: 15px;
            justify-content: center;
            width: 100%;
            margin-top: auto;
            padding-bottom: 20px;
        }

        .btn-round {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: transform 0.1s;
        }
        .btn-round:active { transform: scale(0.9); }
        .btn-skip { background: #fff; color: #94a3b8; border: 2px solid #e2e8f0; }
        .btn-like { background: var(--primary-color); color: #fff; border: 2px solid var(--primary-color); width: 70px; height: 70px; font-size: 1.8em; }

        /* è©•ä¾¡ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã‚«ãƒ¼ãƒ‰å†…ã«è¡¨ç¤ºï¼‰ */
        .rating-overlay {
            position: absolute;
            inset: 0;
            background: rgba(255,255,255,0.98);
            z-index: 20;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 20px;
        }
        .rating-stars {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }
        .star-btn {
            background: none;
            border: none;
            font-size: 2.5em;
            color: #cbd5e1;
            cursor: pointer;
            transition: color 0.2s;
        }
        .star-btn:hover, .star-btn.active {
            color: var(--warning-color);
        }

        /* å®Œäº†ç”»é¢ */
        .completion-screen {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
    </style>
</head>
<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ (ãƒ­ã‚´ã¨æˆ»ã‚‹ãƒœã‚¿ãƒ³) -->
    <div style="padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
        <a href="{{ url_for('index') }}">
            <img src="{{ url_for('static', filename='Blueonly.png') }}" alt="ãƒ­ã‚´" style="height: 30px;">
        </a>
        <a href="{{ url_for('index') }}" class="btn-cancel" style="padding: 6px 15px; font-size: 0.9em;">çµ‚äº†</a>
    </div>

    <div class="swipe-mode-container">
        <!-- èª¬æ˜ãƒ†ã‚­ã‚¹ãƒˆ -->
        <div style="margin-bottom: 20px;">
            <h1 class="app-title-small" style="margin-bottom: 5px; font-size: 1.5em;">âš¡ é«˜é€Ÿãƒ¬ãƒ“ãƒ¥ãƒ¼</h1>
            <p style="color: var(--text-sub); font-size: 0.9em; margin: 0;">
                å—è¬›ã—ãŸè¬›ç¾©ã‚’ç›´æ„Ÿçš„ã«è©•ä¾¡ã—ã‚ˆã†ã€‚<br>
                <!-- â–¼â–¼â–¼ ä¿®æ­£: æ³¨é‡ˆã‚’è¿½åŠ  â–¼â–¼â–¼ -->
                <span style="color: #94a3b8; font-size: 0.85em;">â€» é«˜é€Ÿãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã¯CPã¯ç²å¾—ã§ãã¾ã›ã‚“ï¼ˆãƒ©ãƒ³ã‚¯ç”¨ä»¶æ•°ã«ã¯åŠ ç®—ã•ã‚Œã¾ã™ï¼‰</span>
                <!-- â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–² -->
            </p>
        </div>

        <!-- ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div class="swipe-card-container" id="card-container">
            <!-- ã‚«ãƒ¼ãƒ‰ã¯JSã§ã“ã“ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
            <div class="completion-screen" id="completion-view">
                <div style="font-size: 4em; margin-bottom: 20px;">ğŸ‰</div>
                <h2 style="color: var(--primary-color);">ã™ã¹ã¦è©•ä¾¡ã—ã¾ã—ãŸï¼</h2>
                <p>ç¾åœ¨è¡¨ç¤ºã§ãã‚‹æœªè©•ä¾¡ã®è¬›ç¾©ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<br>ã¾ãŸå¾Œã§ãƒã‚§ãƒƒã‚¯ã—ã¦ã¿ã¦ãã ã•ã„ã€‚</p>
                <a href="{{ url_for('index') }}" class="btn" style="width: auto; margin-top: 20px;">ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</a>
            </div>
        </div>

        <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
        <div class="action-area" id="action-buttons">
            <button class="btn-round btn-skip" onclick="triggerSwipe('left')" title="çŸ¥ã‚‰ãªã„ / å—è¬›ã—ã¦ã„ãªã„">âœ–</button>
            <button class="btn-round btn-like" onclick="triggerSwipe('right')" title="å—è¬›ã—ãŸï¼">âœ”</button>
        </div>
    </div>

    <script>
        let cardsData = [];
        let currentIndex = 0;
        const container = document.getElementById('card-container');
        const completionView = document.getElementById('completion-view');
        const actionButtons = document.getElementById('action-buttons');

        // åˆæœŸåŒ–å‡¦ç†
        document.addEventListener('DOMContentLoaded', () => {
            fetchCards();
        });

        // è¬›ç¾©ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
        function fetchCards() {
            // â–¼â–¼â–¼ ä¿®æ­£: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã§ã®ã‚¨ãƒ©ãƒ¼å›é¿ç”¨ã®ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ â–¼â–¼â–¼
            if (window.location.protocol === 'blob:' || window.location.protocol === 'file:') {
                console.log('Running in preview mode: Using mock data.');
                cardsData = [
                    { id: 999, name: 'ã€ãƒ‡ãƒ¢ã€‘ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°æ¼”ç¿’', teacher: 'ãƒ†ã‚¹ãƒˆæ•™å“¡A', department: 'å·¥å­¦éƒ¨', format: 'å¯¾é¢' },
                    { id: 998, name: 'ã€ãƒ‡ãƒ¢ã€‘ç·šå½¢ä»£æ•°', teacher: 'ãƒ†ã‚¹ãƒˆæ•™å“¡B', department: 'ç†å­¦éƒ¨', format: 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³' },
                    { id: 997, name: 'ã€ãƒ‡ãƒ¢ã€‘è‹±èªã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³', teacher: 'ãƒ†ã‚¹ãƒˆæ•™å“¡C', department: 'å…±é€šæ•™è‚²', format: 'å¯¾é¢' }
                ];
                renderCard();
                return;
            }
            // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

            fetch('/api/fetch_cards')
                .then(res => res.json())
                .then(data => {
                    cardsData = data;
                    if (cardsData.length > 0) {
                        renderCard();
                    } else {
                        showCompletion();
                    }
                })
                .catch(err => {
                    console.error('Error fetching cards:', err);
                    showCompletion();
                });
        }

        // ã‚«ãƒ¼ãƒ‰ã®ç”Ÿæˆã¨è¡¨ç¤º
        function renderCard() {
            if (currentIndex >= cardsData.length) {
                showCompletion();
                return;
            }

            const course = cardsData[currentIndex];
            
            // ã‚«ãƒ¼ãƒ‰è¦ç´ ä½œæˆ
            const card = document.createElement('div');
            card.className = 'swipe-card';
            card.id = 'active-card';
            
            // å†…å®¹ç”Ÿæˆ
            card.innerHTML = `
                <div class="badge-overlay badge-like">LIKE</div>
                <div class="badge-overlay badge-nope">NOPE</div>
                
                <h3 class="card-course-name">${course.name}</h3>
                <p class="card-teacher">${course.teacher}</p>
                
                <div class="card-tags">
                    <span class="tag">${course.department || 'å­¦éƒ¨ä¸æ˜'}</span>
                    <span class="tag">${course.format || 'å½¢å¼ä¸æ˜'}</span>
                </div>

                <!-- è©•ä¾¡å…¥åŠ›ç”»é¢ (åˆæœŸã¯éè¡¨ç¤º) -->
                <div class="rating-overlay" id="rating-view">
                    <h3 style="color: var(--text-main); margin-bottom: 20px;">è©•ä¾¡ã‚’é¸æŠ</h3>
                    <div class="rating-stars">
                        <button class="star-btn" onclick="submitRating(1)">â˜…</button>
                        <button class="star-btn" onclick="submitRating(2)">â˜…</button>
                        <button class="star-btn" onclick="submitRating(3)">â˜…</button>
                        <button class="star-btn" onclick="submitRating(4)">â˜…</button>
                        <button class="star-btn" onclick="submitRating(5)">â˜…</button>
                    </div>
                    <p style="font-size: 0.9em; color: var(--text-sub);">æ˜Ÿã‚’é¸ã‚“ã§æŠ•ç¨¿</p>
                    <button onclick="cancelRating()" class="btn-cancel" style="margin-top: 20px; padding: 5px 15px; font-size: 0.8em;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            `;

            container.appendChild(card);
            
            // ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆã®ç™»éŒ²
            initSwipeEvent(card);
            
            // æ˜Ÿã®ãƒ›ãƒãƒ¼åŠ¹æœè¨­å®š
            setupStarHover(card);
        }

        // ã‚¹ãƒ¯ã‚¤ãƒ—ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
        function initSwipeEvent(card) {
            let startX = 0, startY = 0;
            let moveX = 0, moveY = 0;
            let isDragging = false;

            const likeBadge = card.querySelector('.badge-like');
            const nopeBadge = card.querySelector('.badge-nope');

            const onStart = (e) => {
                // è©•ä¾¡ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã¨ãã¯ã‚¹ãƒ¯ã‚¤ãƒ—ç„¡åŠ¹
                if(card.querySelector('#rating-view').style.display === 'flex') return;

                isDragging = true;
                startX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                startY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
                card.style.transition = 'none';
            };

            const onMove = (e) => {
                if (!isDragging) return;
                
                e.preventDefault(); // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢
                
                const currentX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                const currentY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
                
                moveX = currentX - startX;
                moveY = currentY - startY;
                
                // ã‚«ãƒ¼ãƒ‰ç§»å‹•ã¨å›è»¢
                const rotate = moveX * 0.1;
                card.style.transform = `translate(${moveX}px, ${moveY}px) rotate(${rotate}deg)`;

                // ãƒãƒƒã‚¸ã®ä¸é€æ˜åº¦èª¿æ•´
                if (moveX > 0) {
                    likeBadge.style.opacity = Math.min(moveX / 100, 1);
                    nopeBadge.style.opacity = 0;
                } else {
                    nopeBadge.style.opacity = Math.min(Math.abs(moveX) / 100, 1);
                    likeBadge.style.opacity = 0;
                }
            };

            const onEnd = () => {
                if (!isDragging) return;
                isDragging = false;
                
                const threshold = 100; // ã‚¹ãƒ¯ã‚¤ãƒ—åˆ¤å®šã®é–¾å€¤

                if (moveX > threshold) {
                    // å³ã‚¹ãƒ¯ã‚¤ãƒ—ï¼ˆLIKE -> è©•ä¾¡ã¸ï¼‰
                    showRatingView(card);
                    // ã‚«ãƒ¼ãƒ‰ã®ä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆ
                    card.style.transition = 'transform 0.3s ease';
                    card.style.transform = 'translate(0, 0) rotate(0deg)';
                    likeBadge.style.opacity = 0;
                } else if (moveX < -threshold) {
                    // å·¦ã‚¹ãƒ¯ã‚¤ãƒ—ï¼ˆSKIPï¼‰
                    animateCardOut(card, 'left');
                } else {
                    // å…ƒã«æˆ»ã‚‹
                    card.style.transition = 'transform 0.3s ease';
                    card.style.transform = 'translate(0, 0) rotate(0deg)';
                    likeBadge.style.opacity = 0;
                    nopeBadge.style.opacity = 0;
                }
                
                moveX = 0;
                moveY = 0;
            };

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            card.addEventListener('mousedown', onStart);
            card.addEventListener('touchstart', onStart);
            
            document.addEventListener('mousemove', onMove);
            document.addEventListener('touchmove', onMove, { passive: false });
            
            document.addEventListener('mouseup', onEnd);
            document.addEventListener('touchend', onEnd);
        }

        // ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ã®ã‚¹ãƒ¯ã‚¤ãƒ—
        function triggerSwipe(direction) {
            const card = document.getElementById('active-card');
            if (!card) return;

            if (direction === 'right') {
                showRatingView(card);
            } else {
                animateCardOut(card, 'left');
            }
        }

        // è©•ä¾¡ç”»é¢ã‚’è¡¨ç¤º
        function showRatingView(card) {
            const ratingView = card.querySelector('#rating-view');
            ratingView.style.display = 'flex';
            actionButtons.style.visibility = 'hidden'; // ä¸‹éƒ¨ãƒœã‚¿ãƒ³ã‚’éš ã™
        }

        // è©•ä¾¡ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        function cancelRating() {
            const card = document.getElementById('active-card');
            const ratingView = card.querySelector('#rating-view');
            ratingView.style.display = 'none';
            actionButtons.style.visibility = 'visible';
        }

        // è©•ä¾¡é€ä¿¡
        function submitRating(stars) {
            const course = cardsData[currentIndex];
            const formData = new FormData();
            
            formData.append('rating', stars + '.0');
            formData.append('attendance', 'ãã®ä»–'); // é«˜é€Ÿãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
            formData.append('test', 'ãã®ä»–');
            formData.append('report', 'ãã®ä»–');
            formData.append('review', 'ã€é«˜é€Ÿãƒ¬ãƒ“ãƒ¥ãƒ¼ã€‘');
            formData.append('course_format', course.format || 'ãã®ä»–');

            // â–¼â–¼â–¼ ä¿®æ­£: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã§ã®ã‚¨ãƒ©ãƒ¼å›é¿ç”¨ã®ãƒ€ãƒŸãƒ¼é€ä¿¡ â–¼â–¼â–¼
            if (window.location.protocol === 'blob:' || window.location.protocol === 'file:') {
                console.log('Preview mode: Rating simulated');
                const card = document.getElementById('active-card');
                animateCardOut(card, 'right');
                return;
            }
            // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

            // APIé€ä¿¡
            fetch(`/add_review/${course.id}`, {
                method: 'POST',
                body: formData
            })
            .then(res => {
                if (res.ok) {
                    const card = document.getElementById('active-card');
                    animateCardOut(card, 'right'); // å³ã«æ¶ˆã™
                } else {
                    alert('é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            })
            .catch(err => console.error(err));
        }

        // ã‚«ãƒ¼ãƒ‰ã‚’ç”»é¢å¤–ã¸ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã•ã›ã¦æ¶ˆã™
        function animateCardOut(card, direction) {
            const moveX = direction === 'right' ? window.innerWidth : -window.innerWidth;
            const rotate = direction === 'right' ? 30 : -30;
            
            card.style.transition = 'transform 0.4s ease, opacity 0.4s ease';
            card.style.transform = `translate(${moveX}px, 50px) rotate(${rotate}deg)`;
            card.style.opacity = 0;

            setTimeout(() => {
                card.remove();
                currentIndex++;
                actionButtons.style.visibility = 'visible'; // ãƒœã‚¿ãƒ³å†è¡¨ç¤º
                renderCard();
            }, 400);
        }

        // å®Œäº†ç”»é¢ã®è¡¨ç¤º
        function showCompletion() {
            actionButtons.style.display = 'none';
            completionView.style.display = 'flex';
        }

        // æ˜Ÿã®ãƒ›ãƒãƒ¼å‡¦ç†ï¼ˆç°¡æ˜“å®Ÿè£…ï¼‰
        function setupStarHover(card) {
            const buttons = card.querySelectorAll('.star-btn');
            buttons.forEach((btn, idx) => {
                btn.onmouseover = () => {
                    buttons.forEach((b, i) => {
                        b.style.color = i <= idx ? '#f59e0b' : '#cbd5e1';
                    });
                };
                btn.onmouseout = () => {
                    buttons.forEach(b => b.style.color = '#cbd5e1');
                };
            });
        }
    </script>
</body>
</html>