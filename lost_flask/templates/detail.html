<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>è¬›ç¾©è©³ç´°</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v=5">
    
</head>
<body>
        <a href="{{ url_for('index') }}">
            <img src="{{ url_for('static', filename='Blueonly.png') }}" alt="å¤§å­¦ãƒ­ã‚´" id="logo-banner">
        </a>

    <div class="user-header">
        <a href="{{ url_for('swipe_page') }}" class="header-action-btn">
            âš¡ é«˜é€Ÿãƒ¬ãƒ“ãƒ¥ãƒ¼
        </a>

        <div class="dropdown" tabindex="0">
            <div class="dropbtn">
                <span>{{ current_user.username }} ã•ã‚“</span>
                <span style="font-size: 0.8em; margin-left: 5px;">â–¼</span>
            </div>
            <div class="dropdown-content">
                <a href="{{ url_for('mypage') }}">ğŸ‘¤ ãƒã‚¤ãƒšãƒ¼ã‚¸</a>
                <!-- ã€è¿½åŠ ã€‘ãŠæ°—ã«å…¥ã‚Šã¸ã®ãƒªãƒ³ã‚¯ -->
                <a href="{{ url_for('my_favorites') }}">ğŸ’– ãŠæ°—ã«å…¥ã‚Šè¬›ç¾©</a>
                <a href="{{ url_for('help_page') }}">â“ ä½¿ã„æ–¹</a>
                <a href="{{ url_for('logout') }}" class="logout-item">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
            </div>
        </div>
    </div>

    <div class="container">
        <header class="main-header">
            <h1 class="app-title" style="font-size: 1.8em;">ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æŠ•ç¨¿</h1>
        </header>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
              {% for category, message in messages %}
                <div class="flash-message {{ category }}">{{ message }}</div>
              {% endfor %}
            {% endif %}
        {% endwith %}

        {% if current_user.email.endswith('@demo.com') %}
        <div class="flash-message info">
            ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒ‡ãƒ¢å‹•ä½œã®ãŸã‚ã€ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚
        </div>
        {% endif %}

        <!-- â–¼â–¼â–¼ ä¿®æ­£: ã“ã“ã«ã‚ã£ãŸé»„è‰²ã„è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ â–¼â–¼â–¼ -->
        <!-- é–²è¦§ãƒ­ãƒƒã‚¯ä¸­ã®flash-messageã‚’å‰Šé™¤ã—ã¾ã—ãŸ -->
        <!-- â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–² -->

        <section class="course-info">
            <div class="course-info-details">
                <p><strong>è¬›ç¾©åï¼š</strong> {{ course.name }}</p>
                <p><strong>æ‹…å½“æ•™å“¡ï¼š</strong> {{ course.teacher }}</p>
                <p><strong>ç·åˆè©•ä¾¡ï¼š</strong>â˜… {{ course.star_rating }} / 5.00</p>
                <p><strong>ç§‘ç›®ç•ªå·ï¼š</strong> {{ course.subject_code or 'æœªç™»éŒ²' }}</p>
                <p><strong>é–‹è¬›å­¦éƒ¨ç­‰ï¼š</strong> {{ course.department or 'æœªç™»éŒ²' }}</p>
                <p><strong>å˜ä½æ•°ï¼š</strong> {{ course.credits or 'æœªç™»éŒ²' }}</p>
                <p><strong>æˆæ¥­å½¢å¼ï¼š</strong> {{ course.format or 'æœªç™»éŒ²' }}</p>
                {% if course.syllabus_url %}
                <p><strong>ã‚·ãƒ©ãƒã‚¹ï¼š</strong> 
                    <a href="{{ course.syllabus_url }}" target="_blank" rel="noopener noreferrer">
                        ãƒªãƒ³ã‚¯ã‚’é–‹ã {% if course.syllabus_year %}({{ course.syllabus_year }}){% endif %}
                    </a>
                </p>
                {% endif %}

                <!-- ãŠæ°—ã«å…¥ã‚Šãƒœã‚¿ãƒ³ -->
                <button id="favorite-btn" class="btn-reaction" style="margin-top: 15px; font-size: 1.0em; padding: 0; background: none; border: none; cursor: pointer;" onclick="toggleFavorite({{ course.id }})">
                    <div class="reaction-icon-wrapper" id="fav-icon-wrapper" 
                         style="{% if course in current_user.favorite_courses %}background-color: #fee2e2; border-color: #ef4444; color: #ef4444;{% endif %}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="{% if course in current_user.favorite_courses %}currentColor{% else %}none{% endif %}" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                        </svg>
                    </div>
                    <span id="fav-text" style="margin-left: 8px; font-weight: bold; color: #64748b;">
                        {% if course in current_user.favorite_courses %}
                            ãŠæ°—ã«å…¥ã‚Šæ¸ˆã¿
                        {% else %}
                            ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ 
                        {% endif %}
                    </span>
                </button>
            </div>

            <div class="rating-distribution-container">
                <h4>è©•ä¾¡ã®åˆ†å¸ƒ</h4>
                {% for star in ['5', '4', '3', '2', '1'] %}
                <div class="rating-bar-row">
                    <span class="rating-bar-label">æ˜Ÿ{{ star }}</span>
                    <div class="rating-bar-wrapper">
                        <div class="rating-bar-fill" style="width: {{ rating_distribution[star].percentage }}%;"></div>
                    </div>
                    <span class="rating-bar-count">({{ rating_distribution[star].count }})</span>
                </div>
                {% endfor %}
            </div>
        </section>

        <section class="review-form-section">
            <h2 style="margin-bottom: 20px;">ã‚ãªãŸã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æŠ•ç¨¿</h2>
            <form action="{{ url_for('add_review', id=course.id) }}" method="post">
                <h4>ç·åˆè©•ä¾¡ <span style="color:red">*</span></h4>
                <div class="star-rating-input">
                    <input type="radio" id="star5" name="rating" value="5.0" required><label for="star5" class="star" title="5.0">â˜…</label>
                    <input type="radio" id="star4" name="rating" value="4.0"><label for="star4" class="star" title="4.0">â˜…</label>
                    <input type="radio" id="star3" name="rating" value="3.0"><label for="star3" class="star" title="3.0">â˜…</label>
                    <input type="radio" id="star2" name="rating" value="2.0"><label for="star2" class="star" title="2.0">â˜…</label>
                    <input type="radio" id="star1" name="rating" value="1.0"><label for="star1" class="star" title="1.0">â˜…</label>
                </div>

                <h4>å‡ºå¸­ç¢ºèª <span style="color:red">*</span></h4>
                <div class="radio-group">
                    <label>
                        <input type="radio" name="attendance" value="ã‚ã‚Š" required>
                        <span>ã‚ã‚Š</span>
                    </label>
                    <label>
                        <input type="radio" name="attendance" value="ãªã—">
                        <span>ãªã—</span>
                    </label>
                    <label>
                        <input type="radio" name="attendance" value="ãã®ä»–">
                        <span>ãã®ä»–</span>
                    </label>
                </div>

                <h4>ãƒ†ã‚¹ãƒˆ <span style="color:red">*</span></h4>
                <div class="radio-group">
                    <label>
                        <input type="radio" name="test" value="ã‚ã‚Š" required>
                        <span>ã‚ã‚Š</span>
                    </label>
                    <label>
                        <input type="radio" name="test" value="ãªã—">
                        <span>ãªã—</span>
                    </label>
                    <label>
                        <input type="radio" name="test" value="ãã®ä»–">
                        <span>ãã®ä»–</span>
                    </label>
                </div>

                <h4>ãƒ¬ãƒãƒ¼ãƒˆ <span style="color:red">*</span></h4>
                <div class="radio-group">
                    <label>
                        <input type="radio" name="report" value="ã‚ã‚Š" required>
                        <span>ã‚ã‚Š</span>
                    </label>
                    <label>
                        <input type="radio" name="report" value="ãªã—">
                        <span>ãªã—</span>
                    </label>
                    <label>
                        <input type="radio" name="report" value="ãã®ä»–">
                        <span>ãã®ä»–</span>
                    </label>
                </div>

                <h4>æˆæ¥­å½¢å¼</h4>
                <div class="radio-group">
                    <label>
                        <input type="radio" name="course_format" value="å¯¾é¢" checked>
                        <span>å¯¾é¢</span>
                    </label>
                    <label>
                        <input type="radio" name="course_format" value="ã‚ªãƒ³ãƒ©ã‚¤ãƒ³">
                        <span>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</span>
                    </label>
                    <label>
                        <input type="radio" name="course_format" value="ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰">
                        <span>ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰</span>
                    </label>
                </div>

                <h4>é–‹è¬›å¹´åº¦</h4>
                <input type="text" name="year" placeholder="ä¾‹ï¼š 2024å¹´åº¦ å‰æœŸ" value="{{ course.syllabus_year or '' }}">

                <h4>é–‹è¬›æ•™å®¤</h4>
                <input type="text" name="classroom" placeholder="ä¾‹ï¼š å…±é€šæ•™è‚²æ£Ÿ1-101">
                
                <h4>å‚™è€ƒæ¬„ <small style="font-weight:normal; color:var(--text-sub)">(ä»»æ„)</small></h4>
                <textarea name="review" placeholder="å˜ä½ã®å–ã‚Šã‚„ã™ã•ã€èª²é¡Œã®é‡ã€ãƒ†ã‚¹ãƒˆå½¢å¼ã€ãã®ä»–ç‰¹è¨˜äº‹é …ãªã©"></textarea>

                <button type="submit" class="btn" style="margin-top: 20px;">æŠ•ç¨¿ã™ã‚‹</button>
            </form>
            
            <div style="margin-top: 30px; text-align: center;">
                 <a href="{{ url_for('course_view_detail', id=course.id) }}" class="back-link">ãƒ¬ãƒ“ãƒ¥ãƒ¼é–²è¦§ãƒšãƒ¼ã‚¸ã¸</a>
            </div>
        </section>
    </div>

    <!-- ãŠæ°—ã«å…¥ã‚Šæ©Ÿèƒ½ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script>
    function toggleFavorite(courseId) {
        fetch('/api/toggle_favorite', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ course_id: courseId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const wrapper = document.getElementById('fav-icon-wrapper');
                const text = document.getElementById('fav-text');
                const svg = wrapper.querySelector('svg');

                if (data.is_favorited) {
                    wrapper.style.backgroundColor = '#fee2e2';
                    wrapper.style.borderColor = '#ef4444';
                    wrapper.style.color = '#ef4444';
                    svg.setAttribute('fill', 'currentColor');
                    text.textContent = 'ãŠæ°—ã«å…¥ã‚Šæ¸ˆã¿';
                } else {
                    wrapper.style.backgroundColor = '';
                    wrapper.style.borderColor = '#ccc';
                    wrapper.style.color = '#999';
                    svg.setAttribute('fill', 'none');
                    text.textContent = 'ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ ';
                }
            }
        });
    }
    </script>
</body>
</html>